name: MacOS Intel (x86-64) Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v1.0.0)'
        required: true
        default: 'manual-build'
      is_release:
        description: 'Set to true if triggered by Dispatcher'
        required: true
        default: 'false'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rosetta 2
        run: |
          softwareupdate --install-rosetta --agree-to-license

      - name: Install Intel Dependencies
        run: |
          arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          /usr/local/bin/brew install qt@6 poppler pugixml nlohmann-json libxml2 cmake
          
          echo "QT_DIR=/usr/local/opt/qt@6" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/local/opt/libxml2/lib/pkgconfig" >> $GITHUB_ENV
          echo "PATH=/usr/local/bin:/usr/local/opt/qt@6/bin:$PATH" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          arch -x86_64 cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="/usr/local/opt/qt@6" \
            -DCMAKE_OSX_ARCHITECTURES="x86_64" \
            -DCMAKE_INSTALL_PREFIX="dist"

      - name: Build
        run: arch -x86_64 cmake --build build --config Release

      - name: Install and Ad-hoc Sign
        run: |
          arch -x86_64 cmake --install build
          find dist/EdavkiXmlMaker.app -type f -perm +111 -exec codesign -s - --deep --force {} +

      - name: Bundle & Deploy
        run: |
          arch -x86_64 /usr/local/opt/qt@6/bin/macdeployqt dist/EdavkiXmlMaker.app \
            -dmg \
            -executable=dist/EdavkiXmlMaker.app/Contents/MacOS/EdavkiXmlMaker
          
          VER="${{ github.event.inputs.version || github.ref_name }}"
          mv dist/EdavkiXmlMaker.dmg "dist/EdavkiXmlMaker-MacOS-Intel-$VER.dmg"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MacOS-Intel-Build
          path: dist/*.dmg

      - name: Save or Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VER="${{ github.event.inputs.version }}"
          IS_RELEASE="${{ github.event.inputs.is_release }}"
          
          ARCH="Intel" 
          ZIP_NAME="EdavkiXmlMaker-MacOS-$ARCH-$VER.zip"
          
          cd dist
          zip -r "../$ZIP_NAME" EdavkiXmlMaker.app
          cd ..

          if [ "$IS_RELEASE" == "true" ]; then
            echo "Uploading to existing release $VER..."
            gh release upload "$VER" "$ZIP_NAME" --clobber
          fi

      - name: Always Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.workflow }}-${{ github.run_number }}
          path: "*.zip"
          retention-days: 5