name: C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  pull-requests: write
  contents: read
  actions: read

jobs:
  # JOB 1: Logic & Memory Verification
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake g++ make libgtest-dev nlohmann-json3-dev \
                            libpoppler-cpp-dev libpugixml-dev valgrind lcov \
                            qt6-base-dev libgl1-mesa-dev libxkbcommon-x11-0 bc

    - name: Build GTest
      run: |
        cd /usr/src/gtest
        sudo cmake -S . -B build
        sudo cmake --build build
        sudo cmake --install build

    - name: Configure & Build
      run: |
        export QT_QPA_PLATFORM=offscreen
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DSAVE_GENERATED_FILES=0 \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"
        cmake --build build -- -j$(nproc)

    - name: Run Tests & Gather Coverage
      run: |
        export QT_QPA_PLATFORM=offscreen
        lcov --directory . --zerocounters
        ctest --test-dir build --output-on-failure
        lcov --directory . --capture --output-file coverage.info --ignore-errors mismatch
        lcov --extract coverage.info "*/src/*" \
             --output-file coverage.info.filtered \
             --ignore-errors mismatch

    - name: Upload Baseline Coverage
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: main-coverage
        path: coverage.info.filtered

    - name: Download Baseline Coverage
      if: github.event_name == 'pull_request'
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: test-pr.yml
        branch: main
        name: main-coverage
        path: ./base_coverage/
        if_no_artifact_found: warn

    - name: Generate Coverage Summary
      if: github.event_name == 'pull_request'
      run: |
        PR_FILE="coverage.info.filtered"
        BASE_FILE="./base_coverage/coverage.info.filtered"
        
        get_percent() {
          if [ -f "$1" ]; then
            lcov --summary "$1" 2>/dev/null | grep "lines......:" | awk '{print $2}' | tr -d '%'
          else
            echo "0.00"
          fi
        }

        PR_COV=$(get_percent "$PR_FILE")
        BASE_COV=$(get_percent "$BASE_FILE")
        
        RAW_DIFF=$(echo "$PR_COV - $BASE_COV" | bc -l)
        DIFF=$(printf "%.2f" $RAW_DIFF)
        
        EMOJI="âœ…"
        if [[ $DIFF == -* ]]; then EMOJI="âš ï¸"; fi

        echo "### ðŸ“Š Coverage Report Delta" > coverage_summary.md
        if [ ! -f "$BASE_FILE" ]; then
          echo "> â„¹ï¸ **Note:** No baseline found from main. Initial coverage snapshot created." >> coverage_summary.md
        fi
        echo "| Branch | Coverage |" >> coverage_summary.md
        echo "| :--- | :--- |" >> coverage_summary.md
        echo "| Main (Base) | ${BASE_COV}% |" >> coverage_summary.md
        echo "| PR (This change) | ${PR_COV}% |" >> coverage_summary.md
        echo "" >> coverage_summary.md
        echo "**Difference:** ${EMOJI} ${DIFF}%" >> coverage_summary.md

    - name: Post Delta Comment
      if: github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./coverage_summary.md

    - name: PR Coverage Report
      if: github.event_name == 'pull_request'
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: ./coverage.info.filtered
        filter-changed-files: false 

    - name: Valgrind Memory Check
      run: |
        export QT_QPA_PLATFORM=offscreen
        set -e
        # Test_gui not in Valgrind to avoid false positives from Qt drivers
        for t in test_report_loader test_xml_generator test_application_service; do
          valgrind --leak-check=full --error-exitcode=1 "./build/tests/$t"
        done

  # JOB 2: Packaging Verification (PR ONLY)
  check-appimage-packaging:
<<<<<<<< HEAD:.github/workflows/test-pr.yml
    runs-on: ubuntu-latest
========
    runs-on: ubuntu-22.04
>>>>>>>> main:.github/workflows/test-pr.yml.disable
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4

    - name: Verify Production Build
      run: make release-linux VERSION="check-${{ github.event.number }}"

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Linux-AppImage-Check
        path: production/linux/v*/bin/*.AppImage
        retention-days: 5