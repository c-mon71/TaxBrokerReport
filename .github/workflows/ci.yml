name: C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  pull-requests: write
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake g++ make libgtest-dev nlohmann-json3-dev \
                            libpoppler-cpp-dev libpugixml-dev valgrind lcov \
                            qt6-base-dev libgl1-mesa-dev libxkbcommon-x11-0

    - name: Build GTest
      run: |
        cd /usr/src/gtest
        sudo cmake -S . -B build
        sudo cmake --build build
        sudo cmake --install build

    - name: Configure & Build
      run: |
        export QT_QPA_PLATFORM=offscreen
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DSAVE_GENERATED_FILES=0
        cmake --build build -- -j$(nproc)

    - name: Run Tests & Gather Coverage
      run: |
        export QT_QPA_PLATFORM=offscreen
        lcov --directory . --zerocounters
        
        # 1. Run all tests using ctest (cleaner than calling binaries manually)
        ctest --test-dir build --output-on-failure
        
        # 2. Capture coverage
        lcov --directory . --capture --output-file coverage.info --ignore-errors mismatch
        
        # 3. Use the "Whitelist" extraction we perfected locally
        # This includes src (app, backend, gui) and the root util folder
        lcov --extract coverage.info "*/src/*" "*/util/*" \
             --output-file coverage.info.filtered \
             --ignore-errors mismatch

    - name: PR Coverage Report
      if: github.event_name == 'pull_request'
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: ./coverage.info.filtered
        # Changed to false so you can see the total project health, 
        # not just the lines you touched.
        filter-changed-files: false 

    - name: Valgrind Memory Check
      run: |
        export QT_QPA_PLATFORM=offscreen
        set -e
        # Added test_gui to the loop
        for t in test_report_loader test_xml_generator test_application_service test_gui; do
          valgrind --leak-check=full --error-exitcode=1 "./build/$t"
        done