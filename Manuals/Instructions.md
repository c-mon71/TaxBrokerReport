# EdavkiXmlMaker - Quick Start (Docker)

## Overview

EdavkiXmlMaker parses PDF tax documents and generates XML. This guide covers how to configure, build, test, and run the project using Docker.

- All dependencies are already installed in the Docker image (`edavki-dev`).
- No need to install CMake, GTest, Poppler, or other tools on your host.

## Folder Structure

```plaintext
EdavkiXmlMaker/
â”œâ”€ src/                 # Source code
â”œâ”€ include/             # Headers
â”œâ”€ tests/               # Unit tests
â”œâ”€ util/                # Utility code and headers
â”œâ”€ docs/                # Documentation
â”œâ”€ resources/           # Configuration and XML resources
â”œâ”€ scripts/             # Build and CI scripts
â”œâ”€ build/               # Build folder (ignored by git)
â”œâ”€ bin/                 # Compiled binaries (ignored by git)
â”œâ”€ Dockerfile
â”œâ”€ Makefile
â”œâ”€ CMakeLists.txt
â”œâ”€ LICENSE
â””â”€ README.md
```

### Project in depth Structure

``` plaintext
EdavkiXmlMaker/
â”œâ”€â”€ CMakeLists.txt                 # CMake build configuration
â”œâ”€â”€ Dockerfile                     # Multi-stage Docker build
â”œâ”€â”€ LICENSE                        # Project license
â”œâ”€â”€ Makefile                       # Main build and dev workflow
â”œâ”€â”€ README.md                      # Project overview
â”œâ”€â”€ bin/                           # Compiled binaries (ignored by git)
â”œâ”€â”€ build/                         # Build folder (ignored by git)
â”œâ”€â”€ docs/                          # Documentation
â”‚   â””â”€â”€ ArchitecturePlan.md
â”œâ”€â”€ include/                       # C++ header files
â”‚   â”œâ”€â”€ platform_config.hpp
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ application_service.hpp
â”‚   â””â”€â”€ backend/
â”‚       â”œâ”€â”€ report_loader.hpp
â”‚       â””â”€â”€ xml_generator.hpp
â”œâ”€â”€ Manuals/                       # Documentation and instructions
â”‚   â””â”€â”€ Instructions.md            # This file
â”œâ”€â”€ resources/                     # Configuration and XML resources
â”‚   â””â”€â”€ xml/
â”‚       â””â”€â”€ edavk/
â”œâ”€â”€ scripts/                       # Build and CI scripts
â”‚   â””â”€â”€ run_ci_locally.sh
â”œâ”€â”€ src/                           # Main source code
â”‚   â”œâ”€â”€ main.cpp
â”‚   â”œâ”€â”€ platform_config.cpp
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ application_service.cpp
â”‚   â””â”€â”€ backend/
â”‚       â”œâ”€â”€ report_loader.cpp
â”‚       â””â”€â”€ xml_generator.cpp
â”œâ”€â”€ tests/                         # Unit tests (Google Test)
â”‚   â”œâ”€â”€ helper.cpp
â”‚   â”œâ”€â”€ helper.hpp
â”‚   â”œâ”€â”€ test_application_service.cpp
â”‚   â”œâ”€â”€ test_report_loader.cpp
â”‚   â”œâ”€â”€ test_xml_generator.cpp
â”‚   â””â”€â”€ testData/
â”‚       â”œâ”€â”€ expected_test_output.json
â”‚       â””â”€â”€ generated_test_data.txt
â”œâ”€â”€ util/                          # Utility code
â”‚   â”œâ”€â”€ config.cpp
â”‚   â”œâ”€â”€ config.hpp
â”‚   â”œâ”€â”€ util_xml.cpp
â”‚   â””â”€â”€ util_xml.hpp
â””â”€â”€ .gitignore                     # Ignored files/folders: build/, tmp/, bin/
```

- `build/` is auto-generated by CMake inside Docker. Do not edit manually.
- Add `/build/` to `.gitignore`.

## Makefile Commands

### 1. Build Dev Docker Image

```bash
make build-image
```

- Creates `edavki-dev` image with all build tools and dependencies.
- Only needs to run once or if dependencies change.

### 2. Configure CMake

```bash
make configure
```

- Creates the `build/` folder inside Docker.
- Prepares project for building.

### 3. Build Project

```bash
make build
```

- Compiles `EdavkiXmlMaker` and test binaries.
- Uses the `build/` folder created by configure.

### 4. Run Tests

```bash
make test
```

- Runs all test binaries: `test_report_loader` and `test_xml_generator`.
- Shows output of any failures.

### 5. Combined: Configure + Build + Test

```bash
make all
```

- Shortcut to run configure, build, and tests sequentially.

### 6. Run Production Image

#### Build Production Image

```bash
make build-prod
```

- Uses multi-stage build to create small production image `edavki-prod`.

#### Run Production Binary

```bash
make run-prod
```

- Executes the compiled `EdavkiXmlMaker` binary.

### 7. Optional: Dev Container for Manual Work

#### Start Detached Dev Container

```bash
make run-dev
```

- Starts an interactive container named `edavki-container`.
- Stays alive in the background (`sleep infinity`).
- Useful for debugging.

#### Open Shell in Dev Container

```bash
make dev-shell
```

- Opens `/bin/bash` inside the dev container.
- You can run `cmake`, `make`, or `gdb` manually.

## Notes & Tips

- No host build folder needed: Docker handles `build/` internally.
- Rebuild dev image if dependencies or Dockerfile changes:

```bash
make build-image
```

- Clean build folder:

```bash
rm -rf build
```

then `make configure` again.

- Add new source/test files:
- Add to `CMakeLists.txt`.
- Then `make configure && make build`.

----

## Troubleshooting & Maintenance

## Cleaning Docker Images & Volumes

- Remove image or volume:

```bash
docker rmi <IMAGE_ID>
docker volume rm <VOLUME_NAME>
```

### Docker Permission Denied Errors

If you encounter:
>`docker: permission denied while trying to connect to the Docker daemon socket at unix`

Add your user to the docker group:

```bash
sudo usermod -aG docker $USER
```

If problems persist, fix volume permissions:

``` bash
make fix-volume-perms
```

>[!Note]
Debugging works for Ubuntu if you install VSCode via official link not Ubuntu store.

### Fixing Build Directory Permissions

- If CMake cannot write to `build/` inside container:

```bash
docker run --rm -v edavki-dev-cache:/app/build alpine chown -R 1000:1000 /app/build
```

- Then run `make configure` again.

### Reset Build Folder

```bash
rm -rf build
make configure
```

----

## Debugging

### ðŸ›  VSCode Debugging Inside Docker Dev Container (C++ Tests)

#### 1. Prerequisites

- **Docker** installed on host machine.
- **VSCode** installed.
- **VSCode extensions**:
  - **C/C++ (ms-vscode.cpptools)** â€“ for IntelliSense & debugging
  - **Remote - Containers (ms-vscode-remote.remote-containers)** â€“ for Dev Containers

#### 2. Open Dev Container in VSCode

1. Run conatiner:

   ```bash
   make dev-container-build
   ```

2. Command Palette â†’ `Dev Containers: Attach to Running Container...`
3. Select `edavki-dev-container`
    - If container is not running: `make dev-container-build` on host
4. Select `/app` as the workspace folder (not `/home/appuser`)
5. VSCode opens inside the container with your project mounted.
6. Install also C/C++ extensions for VSCode, once you are inside container on VSCode

#### 3. Debugging Workflow

- Open test file (e.g., `tests/test_report_loader.cpp`)
- Set breakpoints
- Press **F5** or select launch configuration in Debug panel

#### 4. Notes

- Paths like `${workspaceFolder}/build` must match CMake binary dir
- `PROJECT_SOURCE_DIR` requires CMake to be configured correctly
- All builds/debugs happen inside container; **no docker commands needed in container**
- New tests: replicate launch configuration with new binary

#### 5. Shortcuts

For file that is open and focused:

- **F5**: Start Debugging (Compile and Debug)
- **SHIFT+F5**: Run (Comple and Run)

### Debugging in GDB Cli

Just run:

```bash
make debug-test-report-loader
```

For new debug files we need to add commands in *Makefile*.

#### Example of use

```bash
make debug-test-report-loader
docker run --rm -it --name edavki-container \                                 
  -v "/home/david/PrograminProjects/Edavki/EdavkiXmlMaker":/app \
  --user 1000:1000 \
  edavki-dev \
  bash -c "cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug && cmake --build build && gdb ./build/test_report_loader"
-- C++ Compiler: /usr/bin/c++
-- C++ Compiler Version: 11.4.0    
-- C++ Standard: 23
-- Configuring done (0.0s)              
-- Generating done (0.0s)
-- Build files have been written to: /app/build
[ 45%] Built target EdavkiXmlMaker
[ 54%] Building CXX object CMakeFiles/test_report_loader.dir/tests/test_report_loader.cpp.o
[ 63%] Linking CXX executable test_report_loader
[ 72%] Built target test_report_loader
[100%] Built target test_xml_generator
GNU gdb (Ubuntu 12.1-0ubuntu1~22.04.2) 12.1
Copyright (C) 2022 Free Software Foundation, Inc.
..............
(gdb) break tests/test_report_loader.cpp:8                              
Breakpoint 1 at 0xf5a4: file /app/tests/test_report_loader.cpp, line 8.
(gdb) run
Starting program: /app/build/test_report_loader                        
warning: Error disabling address space randomization: Operation not permitted
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Running main() from ./googletest/src/gtest_main.cc
[==========] Running 1 test from 1 test suite.
[----------] Global test environment set-up.
[----------] 1 test from ReportLoaderTest
[ RUN      ] ReportLoaderTest.GetRawPdfData
Breakpoint 1, ReportLoaderTest_GetRawPdfData_Test::TestBody (this=0x56598ddc64b0) at /app/tests/test_report_loader.cpp:8
8           const std::filesystem::path project_root {PROJECT_SOURCE_DIR};
(gdb) s
std::filesystem::__cxx11::path::path (this=0x7ffc287f6370, __source=...) at /usr/include/c++/11/bits/fs_path.h:288                                       
288           path(_Source const& __source, format = auto_format)
(gdb) c
Continuing.
unknown file: Failure
C++ exception with description "Test PDF file not found at: /app/tests/test_data/test_report.pdf" thrown in the test body.
[  FAILED  ] ReportLoaderTest.GetRawPdfData (119915 ms)
[----------] 1 test from ReportLoaderTest (119915 ms total)
[----------] Global test environment tear-down
[==========] 1 test from 1 test suite ran. (119915 ms total)
[  PASSED  ] 0 tests.
[  FAILED  ] 1 test, listed below:
[  FAILED  ] ReportLoaderTest.GetRawPdfData
 1 FAILED TEST
[Inferior 1 (process 49) exited with code 01]
(gdb) exit
```

## Pipelines

The project uses GitHub Actions for CI/CD. The main pipeline is defined in `.github/workflows/ci.yml`.
We can run the pipeline locally using the: `scripts/run_ci_locally.sh` script.

### Running the CI Pipeline Locally

If you do this for the first time, you need to change the permissions of the script:

```bash
chmod +x scripts/run_ci_locally.sh
```

**When to trigger this command:**

- **First time only**: Run `chmod +x scripts/run_ci_locally.sh` to make the script executable.
- **After that**: You can run the script with:

```bash
scripts/run_ci_locally.sh
```

**Note**: Do not use `sudo` with the script. If you encounter permission issues, ensure your user has proper permissions in the project directory.

>[!Warning]
> This is just a simulation of the GitHub Actions pipeline. It may not perfectly replicate the cloud environment.
> Currently it runs only unit tests.
